$schema: https://json.schemastore.org/github-action.json
name: "Self‚ÄëHealing CI"
description: |
  Run your build once and, if it fails, let Claude
  patch the code in‚Äëplace, retry (up to max_attempts),
  and open a pull‚Äërequest with the fix.

author: "remorses"
branding:
  icon: activity
  color: purple

inputs:
  anthropic_api_key:
    description: "Secret: your Anthropic Claude API key"
    required: true

  command:
    description: "Shell commands that must succeed (run as one string)"
    required: true

  allowed_tools:
    description: |
      Comma‚Äëseparated list of Claude tools allowed.
      Keep minimal for safety; add Bash(gh *) if you want CLAUDE to run gh‚Äëcli.
    default: "Bash(*)"
    required: false

  timeout_minutes:
    description: "Hard time‚Äëout for the Claude session"
    default: "15"
    required: false

  max_turns:
    description: "Max Claude turns (round‚Äëtrips) before the action aborts"
    default: "10"
    required: false

  max_attempts:
    description: "Max build / fix iterations before giving up"
    default: "3"
    required: false

runs:
  using: "composite"
  steps:
    - id: self_heal
      uses: anthropics/claude-code-base-action@beta
      env:
        GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }} # must be set by caller (usually ${{ secrets.GITHUB_TOKEN }})
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        timeout_minutes: ${{ inputs.timeout_minutes }}
        max_turns: ${{ inputs.max_turns }}
        allowed_tools: ${{ inputs.allowed_tools }}

        prompt: |
          You are our CI self‚Äëhealing agent.

          **Workflow**
          1. Run the build once, run this command as your first action, exactly as follows:
             ```
             ${{ inputs.command }}
             ```
          2. If the commands succeed, exit immediately with success‚Äîno commits, no PR.
          3. Otherwise, iterate up to **${{ inputs.max_attempts }} attempts**:
             ‚Ä¢ Diagnose & edit code.
             ‚Ä¢ `git add -A && git commit -m "fix(build): attempt $ATTEMPT"`.
             ‚Ä¢ Re‚Äërun `${{ inputs.command }}`. You can also run only part of the command if only that part is currently failing.
          4. After ${{ inputs.max_attempts }} failed attempts, `exit 1` so the job fails.

          **When the build passes**
          1. Create / switch to a branch `claude/fix-build-${GITHUB_RUN_ID}`.
          2. Push and open a PR:
             ```bash
             git push -u origin "$branch"
             gh pr create \
               --base "${{ github.ref_name }}" \
               --title "fix(build): auto‚Äëheal CI, few words of changes made" \
               --body  "Automated patch generated by Claude Code üõ†Ô∏è, explanation of what was the issue"
             ```
